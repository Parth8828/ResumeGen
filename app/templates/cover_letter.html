{% extends "base.html" %}

{% block title %}AI Cover Letter Generator - ResumeGen{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6">
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-slate-900 dark:text-slate-100 mb-2">AI Cover Letter Generator</h1>
        <p class="text-slate-600 dark:text-slate-300">Generate personalized cover letters in seconds</p>
    </div>

    <!-- Input Form -->
    <div class="glass-card p-6">
        <h2 class="text-xl font-semibold text-slate-800 dark:text-slate-100 mb-4">Job Details</h2>

        <div class="space-y-4">
            <!-- Resume Context -->
            <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                    Your Profile / Resume Context <span class="text-xs text-slate-500">(Auto-filled, feel free to
                        edit)</span>
                </label>
                <textarea id="resume-context" rows="6"
                    class="w-full px-4 py-3 rounded-lg border-slate-300 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 shadow-sm focus:border-primary focus:ring-primary font-sm text-sm"
                    placeholder="Loading your profile data..."></textarea>

                <div class="mt-2 text-right">
                    <button id="get-suggestions-btn" type="button"
                        class="text-sm text-primary hover:text-blue-700 font-medium">
                        <i class="fa-solid fa-lightbulb"></i> Get Job Role & Company Suggestions
                    </button>
                </div>

                <!-- Suggestions Result -->
                <div id="suggestions-area"
                    class="hidden mt-4 p-4 bg-blue-50 dark:bg-slate-800 rounded-lg border border-blue-100 dark:border-slate-600">
                    <h3 class="text-sm font-semibold text-slate-800 dark:text-slate-200 mb-2">Recommended for you:</h3>
                    <div id="suggestions-list" class="space-y-3">
                        <!-- Items will be injected here -->
                    </div>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Job Title *</label>
                <input type="text" id="job-title" placeholder="e.g., Senior Software Engineer"
                    class="w-full px-4 py-3 rounded-lg border-slate-300 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 shadow-sm focus:border-primary focus:ring-primary">
            </div>

            <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Company Name *</label>
                <input type="text" id="company-name" placeholder="e.g., Google"
                    class="w-full px-4 py-3 rounded-lg border-slate-300 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 shadow-sm focus:border-primary focus:ring-primary">
            </div>

            <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Job Description
                    *</label>
                <textarea id="job-description" rows="6" placeholder="Paste the job description here..."
                    class="w-full px-4 py-3 rounded-lg border-slate-300 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 shadow-sm focus:border-primary focus:ring-primary resize-none transition-all"
                    style="min-height: 150px; max-height: 400px; overflow-y: auto;"></textarea>
            </div>

            <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Tone</label>
                <select id="tone-selector"
                    class="w-full px-4 py-3 rounded-lg border-slate-300 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 shadow-sm focus:border-primary focus:ring-primary">
                    <option value="professional">Professional - Formal and corporate</option>
                    <option value="enthusiastic">Enthusiastic - Energetic and passionate</option>
                    <option value="creative">Creative - Unique and personality-driven</option>
                </select>
            </div>

            <button id="generate-btn"
                class="w-full bg-primary hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors flex items-center justify-center gap-2">
                <i class="fa-solid fa-wand-magic-sparkles"></i>
                Generate Cover Letter
            </button>
        </div>
    </div>

    <!-- Generated Cover Letter -->
    <div id="result-section" class="hidden glass-card p-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold text-slate-800 dark:text-slate-100">Your Cover Letter</h2>
            <div class="flex gap-2">
                <button id="copy-btn"
                    class="px-4 py-2 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-200 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-sm">
                    <i class="fa-solid fa-copy"></i> Copy
                </button>
                <button id="download-btn"
                    class="px-4 py-2 bg-primary hover:bg-blue-700 text-white rounded-lg transition-colors text-sm">
                    <i class="fa-solid fa-download"></i> Download PDF
                </button>
            </div>
        </div>

        <textarea id="cover-letter-text" rows="20"
            class="w-full px-4 py-3 rounded-lg border-slate-300 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 shadow-sm focus:border-primary focus:ring-primary font-serif text-base leading-relaxed"
            placeholder="Your generated cover letter will appear here..."></textarea>

        <p class="text-sm text-slate-500 dark:text-slate-400 mt-2">
            <i class="fa-solid fa-info-circle"></i> You can edit the cover letter before downloading
        </p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const jobTitleInput = document.getElementById('job-title');
    const companyNameInput = document.getElementById('company-name');
    const jobDescTextarea = document.getElementById('job-description');
    const toneSelector = document.getElementById('tone-selector');
    const generateBtn = document.getElementById('generate-btn');
    const resultSection = document.getElementById('result-section');
    const coverLetterText = document.getElementById('cover-letter-text');
    const copyBtn = document.getElementById('copy-btn');
    const downloadBtn = document.getElementById('download-btn');

    const resumeContextInput = document.getElementById('resume-context');

    // Load Profile Context on Startup
    async function loadProfileContext() {
        try {
            const response = await axios.get('/api/profile/');
            const p = response.data; // Profile object

            // Format into a readable context string
            let text = `Name: ${p.profile?.full_name || 'Candidate'}\n`;
            text += `Summary: ${p.profile?.summary || ''}\n\n`;

            if (p.skills && p.skills.length) {
                text += `Skills:\n${p.skills.map(c => `- ${c.category}: ${c.skills.join(', ')}`).join('\n')}\n\n`;
            }

            if (p.experiences && p.experiences.length) {
                text += `Experience:\n${p.experiences.map(e => `- ${e.title} at ${e.company}: ${e.description}`).join('\n')}\n\n`;
            }

            if (p.projects && p.projects.length) {
                text += `Projects:\n${p.projects.map(pr => `- ${pr.name}: ${pr.description}`).join('\n')}\n`;
            }

            resumeContextInput.value = text;
        } catch (error) {
            console.error("Could not load profile context", error);
            resumeContextInput.placeholder = "Could not load profile automatically. Please paste your resume summary here.";
        }
    }

    // Initialize
    loadProfileContext();

    // Auto-resize job description textarea
    function autoResizeTextarea(textarea) {
        textarea.style.height = 'auto';
        const newHeight = Math.min(Math.max(textarea.scrollHeight, 150), 400);
        textarea.style.height = newHeight + 'px';
    }

    jobDescTextarea.addEventListener('input', () => {
        autoResizeTextarea(jobDescTextarea);
    });

    autoResizeTextarea(jobDescTextarea);

    // Job Suggestions Logic
    const suggestionsBtn = document.getElementById('get-suggestions-btn');
    const suggestionsArea = document.getElementById('suggestions-area');
    const suggestionsList = document.getElementById('suggestions-list');

    suggestionsBtn.addEventListener('click', async () => {
        const resumeContext = resumeContextInput.value.trim();

        suggestionsBtn.disabled = true;
        suggestionsBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Analyzing Profile...';
        suggestionsArea.classList.add('hidden');

        try {
            const response = await axios.post('/api/cover-letter/suggestions', {
                resume_context: resumeContext
            });

            const data = response.data;
            if (data.suggestions && data.suggestions.length > 0) {
                suggestionsList.innerHTML = data.suggestions.map(s => `
                    <div class="flex items-start gap-3 p-3 bg-white dark:bg-slate-700 rounded border border-slate-200 dark:border-slate-500 hover:border-primary cursor-pointer transition-colors suggestion-item"
                         data-role="${s.role}" data-company="${s.company}" data-description="${s.description || ''}">
                        <div class="flex-1">
                            <h4 class="font-medium text-slate-900 dark:text-slate-100">${s.role}</h4>
                            <p class="text-sm text-slate-600 dark:text-slate-300">at ${s.company}</p>
                            <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">${s.reason}</p>
                        </div>
                        <button class="text-primary text-sm font-medium"><i class="fa-solid fa-plus"></i> Use</button>
                    </div>
                `).join('');

                suggestionsArea.classList.remove('hidden');

                // Add click handlers
                document.querySelectorAll('.suggestion-item').forEach(item => {
                    item.addEventListener('click', () => {
                        jobTitleInput.value = item.dataset.role;
                        companyNameInput.value = item.dataset.company;

                        // Auto-fill Description if available
                        if (item.dataset.description && item.dataset.description !== "undefined") {
                            jobDescTextarea.value = item.dataset.description;
                            autoResizeTextarea(jobDescTextarea);
                        }

                        // Scroll down to job title
                        jobTitleInput.scrollIntoView({ behavior: 'smooth' });
                    });
                });
            } else {
                alert('No specific suggestions found. Try adding more detail to your profile context.');
            }
        } catch (error) {
            console.error(error);
            alert('Failed to get suggestions. Please check your connection or try again.');
        } finally {
            suggestionsBtn.disabled = false;
            suggestionsBtn.innerHTML = '<i class="fa-solid fa-lightbulb"></i> Get Job Role & Company Suggestions';
        }
    });

    // Generate Cover Letter
    generateBtn.addEventListener('click', async () => {
        const jobTitle = jobTitleInput.value.trim();
        const companyName = companyNameInput.value.trim();
        const jobDescription = jobDescTextarea.value.trim();
        const tone = toneSelector.value;
        const resumeContext = resumeContextInput.value.trim();

        if (!jobTitle || !companyName || !jobDescription) {
            alert('Please fill in all required fields');
            return;
        }

        // Show loading state
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Generating...';

        try {
            const response = await axios.post('/api/cover-letter/generate', {
                job_title: jobTitle,
                company_name: companyName,
                job_description: jobDescription,
                tone: tone,
                resume_context: resumeContext
            });

            coverLetterText.value = response.data.cover_letter;
            resultSection.classList.remove('hidden');
            resultSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

        } catch (error) {
            console.error('Error:', error);
            let msg = 'Failed to generate cover letter.';
            if (error.response && error.response.data && error.response.data.detail) {
                msg += ' ' + error.response.data.detail;
            }
            alert(msg);
        } finally {
            generateBtn.disabled = false;
            generateBtn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> Generate Cover Letter';
        }
    });

    // Copy to Clipboard
    copyBtn.addEventListener('click', () => {
        coverLetterText.select();
        document.execCommand('copy');

        const originalText = copyBtn.innerHTML;
        copyBtn.innerHTML = '<i class="fa-solid fa-check"></i> Copied!';
        setTimeout(() => {
            copyBtn.innerHTML = originalText;
        }, 2000);
    });

    // Download as PDF
    downloadBtn.addEventListener('click', async () => {
        const coverLetter = coverLetterText.value;
        if (!coverLetter) {
            alert('No cover letter to download');
            return;
        }

        downloadBtn.disabled = true;
        downloadBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Generating PDF...';

        try {
            const response = await axios.post('/api/cover-letter/download', {
                cover_letter: coverLetter,
                job_title: jobTitleInput.value || 'Job Application', // Fallback
                company_name: companyNameInput.value || 'Company'
            }, {
                responseType: 'blob'
            });

            const url = window.URL.createObjectURL(new Blob([response.data]));
            const link = document.createElement('a');
            link.href = url;
            const filename = (companyNameInput.value || 'Company').replace(/[^a-zA-Z0-9]/g, '_');
            link.setAttribute('download', `Cover_Letter_${filename}.pdf`);
            document.body.appendChild(link);
            link.click();
            link.remove();

        } catch (error) {
            console.error('Error:', error);
            let msg = 'Failed to download PDF.';

            // Handle Blob errors (backend returned JSON error as blob)
            if (error.response && error.response.data instanceof Blob) {
                try {
                    const text = await error.response.data.text();
                    const json = JSON.parse(text);
                    if (json.detail) msg += ' ' + json.detail;
                } catch (e) {
                    // ignore
                }
            } else if (error.message) {
                msg += ' ' + error.message;
            }

            alert(msg);
        } finally {
            downloadBtn.disabled = false;
            downloadBtn.innerHTML = '<i class="fa-solid fa-download"></i> Download PDF';
        }
    });
</script>
{% endblock %}